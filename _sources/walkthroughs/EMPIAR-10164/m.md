# Multi-particle refinement


Now that our particle poses are mostly correct and we have a good estimate of the reconstructed density, there are several parameters that can be tweaked _a posteriori_ to further refine our result. We will perform these optimisations in M.

````{margin}
```{seealso}
We highly recommend [the `M` paper](https://doi.org/10.1101/2020.06.05.136341) to better understand what this software does and is capable of.
```
````

`M` provides a procedure for the concerted optimisation of these parameters.

## Create Population and Species

A project in `M` is referred to as a `population`. To create a new one press the big `+` button in the center of the window, and provide a directory. Here, we put it in `root/M/1.6Apx/`.

We then need to add a data source. Click on `Manage data sources` to add a local source, and select the `*.settings` file inside the `frames` directory. Make sure to `Include items outside of filter ranges` (since we did not use the filters for this project), give it a name such as `HIV` and press `CREATE`. We also only want to `Use only first 15 frames/tilts` in order to refine only based on the high resolution information.

We can then create a Species by pressing the next big '+', selecting `from scratch` and filling in the parameters as follows:

![new_species](m.assets/new_species.png)

Afterwards, selected the two last halfmaps generated by the `RELION` refinements at 1.6Ã…/px. As mask, we will generate one in much the same way as we did previously, but without a cylindrical restriction.

````{margin}
```{note}
Note that this time we are not adding a soft edge: `M` wants a binary map!
```
````
Open one of the halfmaps in your favourite program and determine an appropriate threshold for binarisation. Use this as the `--ini_threshold` parameter in the following command, replacing `<latest_halfmap>` as appropriate:

```bash
relion_mask_create --i <latest_halfmap>.mrc --angpix 1.6 --extend_inimask 5 --o mask_1.6Apx.mrc --ini_threshold 0.05
```

Provide this map to `M`, and then select the final particle positions (e.g: `run_it019_data.star`) for the particle coordinates. Click `FINISH` to generate the new species.

## Refinement Parameters

To start the refinement, click on the `REFINE` button and fill in the parameters as follows.

```{note}
We will do a few iterations of refinements: first some with only spatial parameter optimizations, and then with most parameters. This is to avoid falling into local minima. Try out different settings: this may vary on a case-by-case basis!
```

First, run four iterations with these parameters:
![refinement1](m.assets/refinement1.png)

Afterwards, three iterations as follows:
![refinement2](m.assets/refinement2.png)

## End Result!

If everything went well, after the second round of refinements you should be able to get to something like this:

![result1](m.assets/result1.png)

![result2](m.assets/result2.png)

Congratulations!
